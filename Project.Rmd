---
title: "DS 6373 Time Series Project"
author: "Alexandre Jasserme & Jae Chung"
date: "2024-04-04"
output: html_document
---

```{r setup, include=TRUE}

# Loading the libraries
library(tswge)
library(vars)
library(nnfor)
library(GGally)
library(RColorBrewer)

# Setting seed for consistent results
set.seed(456)

# Loading the Key Economic Indicators data (downloaded from 
# https://data.texas.gov/dataset/Key-Economic-Indicators/karz-jr5v/about_data)
kei = read.csv("Data/Key_Economic_Indicators_20240401.csv", header = TRUE)

# Checking that data was loaded correctly
head(kei)

# We are interested in the modeling the Existing Single Family Home Price TX 
# (column Q) based on the evolution of the Consumer Price Index TX (column G) 
# and Unemployment TX (column L) from January 2007 (since we have missing data 
# from previous time periods)
cpi = na.omit(kei$Consumer.Price.Index.TX)
unemp = na.omit(kei$Unemployment.TX)
home_price = na.omit(kei$Existing.Single.Family.Home.Price.TX)

# Creating the time series objects 
cpi_ts = ts(data = cpi, start = c(2007,1), frequency = 12)
unemp_ts = ts(data = unemp, start = c(2007,1), frequency = 12)
home_price_ts = ts(data = home_price, start = c(2007,1), frequency = 12)

# Plotting the data
plotts.sample.wge(cpi_ts)
# We observe a mostly increasing trend with the main frequency close to 0

plotts.sample.wge(unemp_ts)
# We observe 2 peaks: one during the financial crisis of 2008 and one during the Covid pandemic

plotts.sample.wge(home_price_ts)
# We observe a mostly increasing trends but with seasonal factors (prices are traditionally higher in summer)

# Creating a data frame:
df = data.frame(cpi, unemp, home_price)

# Looking at the data pairs
ggpairs(df)
# Home prices and inflation (via CPI index) are strongly positively correlated
# Home prices and unemployment are negatively correlated

# Training and test set for short term forecast (6 months)

# Data Frame
short_term = 6
train_index_short = nrow(df) - short_term
df_train_s = head(df, n=train_index_short)
df_test_s = tail(df, n=short_term)

# Time series
cpi_ts_train_s = ts(data = df_train_s$cpi, start = c(2007,1), frequency = 12)
unemp_ts_train_s = ts(data = df_train_s$unemp, start = c(2007,1), frequency = 12)
home_price_ts_train_s = ts(data = df_train_s$home_price, start = c(2007,1), frequency = 12)

cpi_ts_test_s = ts(data = df_test_s$cpi, start = c(2023,9), frequency = 12)
unemp_ts_test_s = ts(data = df_test_s$unemp, start = c(2023,9), frequency = 12)
home_price_ts_test_s = ts(data = df_test_s$home_price, start = c(2023,9), frequency = 12)


# Training and test set for long term forecast (5 years)

# Data Frame
long_term = 60
train_index_long = nrow(df) - long_term
df_train_l = head(df, n=train_index_long)
df_test_l = tail(df, n=long_term)

# Time series
cpi_ts_train_l = ts(data = df_train_l$cpi, start = c(2007,1), frequency = 12)
unemp_ts_train_l = ts(data = df_train_l$unemp, start = c(2007,1), frequency = 12)
home_price_ts_train_l = ts(data = df_train_l$home_price, start = c(2007,1), frequency = 12)

cpi_ts_test_l = ts(data = df_test_l$cpi, start = c(2019,3), frequency = 12)
unemp_ts_test_l = ts(data = df_test_l$unemp, start = c(2019,3), frequency = 12)
home_price_ts_test_l = ts(data = df_test_l$home_price, start = c(2019,3), frequency = 12)


# 4a. Fitting ARMA / ARIMA / ARUMA / Signal Plus Noise (univariate analysis)

# Short-term ARMA for cpi
aic5.wge(df_train_s$cpi, p = 0:5, q = 0:3)
est.cpi = est.arma.wge(df_train_s$cpi, p = 4, q = 2)
preds = fore.arma.wge(df_train_s$cpi, phi = est.cpi$phi, n.ahead = 6, lastn = TRUE)
ASE = mean((df_test_s$cpi[(length(df_test_s$cpi)-6+1)] - preds$f)^2)
ASE # 90.57898
RMSE = sqrt(mean((df_test_s$cpi - preds$f[1:6])^2))
RMSE # 10.71134

# Short-term ARIMA for cpi
cpi.d1 = artrans.wge(df_train_s$cpi, phi.tr = 1)
aic5.wge(cpi.d1, p = 0:5, q = 0:3)
est.cpi.d1 = est.arma.wge(cpi.d1, p = 2, q = 1)
preds = fore.arima.wge(df_train_s$cpi, phi = est.cpi.d1$phi, d = 1, n.ahead = 6, lastn = F)
ASE = mean((df_test_s$cpi[(length(df_test_s$cpi)-6+1)] - preds$f)^2)
ASE # 1.446768
RMSE = sqrt(mean((df_test_s$cpi - preds$f[1:6])^2))
RMSE # 2.734241

# Short-term ARUMA for cpi
cpi.12 = artrans.wge(cpi.d1, phi.tr = c(rep(0,11),1))
aic5.wge(cpi.12, p = 0:5, q = 0:3)
est.cpi12 = est.arma.wge(cpi.12, p = 2, q = 1)
preds = fore.aruma.wge(df_train_s$cpi, phi = est.cpi12$phi, s = 12, d = 1, n.ahead = 6, lastn = F)
ASE = mean((df_test_s$cpi[(length(df_test_s$cpi)-6+1)] - preds$f)^2)
ASE # 2.798647
RMSE = sqrt(mean((df_test_s$cpi - preds$f[1:6])^2))
RMSE # 2.396974

# Short-term Signal-Plus Noise for cpi
wbg.boot.wge(df_train_s$cpi) # p-value 0.05263 <- FTR
# Therefore, we will fit the above models only instead of continuing to look for a linear signal.
#xa = slr.wge(cpi)
#xa$res
#xa.aic = aic.burg.wge(xa$res, p = 1:5)



# Short-term ARMA for unemp
aic5.wge(df_train_s$unemp, p = 0:5, q = 0:3)
est.unemp = est.arma.wge(df_train_s$unemp, p = 1, q = 1)
preds = fore.arma.wge(df_train_s$unemp, phi = est.unemp$phi, n.ahead = 6, lastn = TRUE)
ASE = mean((df_test_s$unemp[(length(df_test_s$unemp)-6+1)] - preds$f)^2)
ASE # 0.306961
RMSE = sqrt(mean((df_test_s$unemp - preds$f[1:6])^2))
RMSE # 0.5540406

# Short-term ARIMA for unemp
unemp.d1 = artrans.wge(df_train_s$unemp, phi.tr = 1)
aic5.wge(unemp.d1, p = 0:5, q = 0:3)
est.unemp.d1 = est.arma.wge(unemp.d1, p = 3, q = 1)
preds = fore.arima.wge(df_train_s$unemp, phi = est.unemp.d1$phi, d = 1, n.ahead = 6, lastn = F)
ASE = mean((df_test_s$unemp[(length(df_test_s$unemp)-6+1)] - preds$f)^2)
ASE # 0.001935331
RMSE = sqrt(mean((df_test_s$unemp - preds$f[1:6])^2))
RMSE # 0.0439924

# Short-term ARUMA for unemp
unemp.12 = artrans.wge(unemp.d1, phi.tr = c(rep(0,11),1))
aic5.wge(unemp.12, p = 0:5, q = 0:3)
est.unemp.12 = est.arma.wge(unemp.12, p = 2, q = 3)
preds = fore.aruma.wge(df_train_s$unemp, phi = est.unemp.12$phi, s = 12, d = 1, n.ahead = 6, lastn = F)
ASE = mean((df_test_s$unemp[(length(df_test_s$unemp)-6+1)] - preds$f)^2)
ASE # 0.05166667
RMSE = sqrt(mean((df_test_s$unemp - preds$f[1:6])^2))
RMSE # 0.227303

# Short-term Signal-Plus Noise for unemp
wbg.boot.wge(df_train_s$unemp) # p-value 0.1954887 <- FTR
# Therefore, we will fit the above models only instead of continuing to look for a linear signal.



# Short-term ARMA for home_price
aic5.wge(df_train_s$home_price, p = 0:5, q = 0:3)
est.hp = est.arma.wge(df_train_s$home_price, p = 2, q = 3)
preds = fore.arma.wge(df_train_s$home_price, phi = est.hp$phi, n.ahead = 6, lastn = TRUE)
ASE_ARMA_S = mean((df_test_s$home_price[(length(df_test_s$home_price)-6+1)] - preds$f)^2)
ASE_ARMA_S # 302887206
RMSE_ARMA_S = sqrt(mean((df_test_s$home_price - preds$f[1:6])^2))
RMSE_ARMA_S # 11276.38

# Short-term ARIMA for home_price
hp.d1 = artrans.wge(df_train_s$home_price, phi.tr = 1)
aic5.wge(hp.d1, p = 0:5, q = 0:3)
est.hp.d1 = est.arma.wge(hp.d1, p = 5, q = 3)
preds_ARIMA_S = fore.arima.wge(df_train_s$home_price, phi = est.hp.d1$phi, d = 1, n.ahead = 6, lastn = F)
ASE_ARIMA_S = mean((df_test_s$home_price[(length(df_test_s$home_price)-6+1)] - preds_ARIMA_S$f)^2)
ASE_ARIMA_S # 12498440
RMSE_ARIMA_S = sqrt(mean((df_test_s$home_price - preds_ARIMA_S$f[1:6])^2))
RMSE_ARIMA_S # 5532.287

# Short-term ARUMA for home_price
hp.12 = artrans.wge(hp.d1, phi.tr = c(rep(0,11),1))
aic5.wge(hp.12, p = 0:5, q = 0:3)
est.hp.12 = est.arma.wge(hp.12, p = 2, q = 2)
preds = fore.aruma.wge(df_train_s$home_price, phi = est.hp.12$phi, s = 12, d = 1, n.ahead = 6, lastn = F)
ASE_ARUMA_S = mean((df_test_s$home_price[(length(df_test_s$home_price)-6+1)] - preds$f)^2)
ASE_ARUMA_S # 261542338
RMSE_ARUMA_S = sqrt(mean((df_test_s$home_price - preds$f[1:6])^2))
RMSE_ARUMA_S # 10065.17

# Short-term Signal-Plus Noise for home_price
wbg.boot.wge(df_train_s$home_price) # p-value 0.06516291 <- FTR
# Therefore, we will fit the above models only instead of continuing to look for a linear signal.


# Long-term ARMA for cpi
aic5.wge(df_train_l$cpi, p = 0:5, q = 0:3)
est.cpi = est.arma.wge(df_train_l$cpi, p = 3, q = 0)
preds = fore.arma.wge(df_train_l$cpi, phi = est.cpi$phi, n.ahead = 60, lastn = TRUE)
ASE = mean((df_test_l$cpi[(length(df_test_l$cpi)-60+1)] - preds$f)^2)
ASE # 333.8962
RMSE = sqrt(mean((df_test_l$cpi - preds$f[1:60])^2))
RMSE # 43.68068

# Long-term ARIMA for cpi
cpi.d1 = artrans.wge(df_train_l$cpi, phi.tr = 1)
aic5.wge(cpi.d1, p = 0:5, q = 0:3)
est.cpi.d1 = est.arma.wge(cpi.d1, p = 2, q = 2)
preds = fore.arima.wge(df_train_l$cpi, phi = est.cpi.d1$phi, d = 1, n.ahead = 60, lastn = F)
ASE = mean((df_test_l$cpi[(length(df_test_l$cpi)-60+1)] - preds$f)^2)
ASE # 0.2092139
RMSE = sqrt(mean((df_test_l$cpi - preds$f[1:60])^2))
RMSE # 27.76933

# Long-term ARUMA for cpi
cpi.12 = artrans.wge(cpi.d1, phi.tr = c(rep(0,11),1))
aic5.wge(cpi.12, p = 0:5, q = 0:3)
est.cpi12 = est.arma.wge(cpi.12, p = 3, q = 1)
preds = fore.aruma.wge(df_train_l$cpi, phi = est.cpi12$phi, s = 12, d = 1, n.ahead = 60, lastn = F)
ASE = mean((df_test_l$cpi[(length(df_test_l$cpi)-60+1)] - preds$f)^2)
ASE # 408.5312
RMSE = sqrt(mean((df_test_l$cpi - preds$f[1:60])^2))
RMSE # 47.84829

# Long-term Signal-Plus Noise for cpi
wbg.boot.wge(df_train_l$cpi) # p-value 0 <- Reject



# Long-term ARMA for unemp
aic5.wge(df_train_l$unemp, p = 0:5, q = 0:3)
est.unemp = est.arma.wge(df_train_l$unemp, p = 2, q = 1)
preds = fore.arma.wge(df_train_l$unemp, phi = est.unemp$phi, n.ahead = 60, lastn = TRUE)
ASE = mean((df_test_l$unemp[(length(df_test_l$unemp)-60+1)] - preds$f)^2)
ASE # 5.683878
RMSE = sqrt(mean((df_test_l$unemp - preds$f[1:60])^2))
RMSE # 2.350637

# Long-term ARIMA for unemp
unemp.d1 = artrans.wge(df_train_l$unemp, phi.tr = 1)
aic5.wge(unemp.d1, p = 0:5, q = 0:3)
est.unemp.d1 = est.arma.wge(unemp.d1, p = 1, q = 1)
preds = fore.arima.wge(df_train_l$unemp, phi = est.unemp.d1$phi, d = 1, n.ahead = 60, lastn = F)
ASE = mean((df_test_l$unemp[(length(df_test_l$unemp)-60+1)] - preds$f)^2)
ASE # 0.1330498
RMSE = sqrt(mean((df_test_l$unemp - preds$f[1:60])^2))
RMSE # 2.732234

# Long-term ARUMA for unemp
unemp.12 = artrans.wge(unemp.d1, phi.tr = c(rep(0,11),1))
aic5.wge(unemp.12, p = 0:5, q = 0:3)
est.unemp.12 = est.arma.wge(unemp.12, p = 2, q = 0)
preds = fore.aruma.wge(df_train_l$unemp, phi = est.unemp.12$phi, s = 12, d = 1, n.ahead = 60, lastn = F)
ASE = mean((df_test_l$unemp[(length(df_test_l$unemp)-60+1)] - preds$f)^2)
ASE # 1.336393
RMSE = sqrt(mean((df_test_l$unemp - preds$f[1:60])^2))
RMSE # 3.116287

# Long-term Signal-Plus Noise for unemp
wbg.boot.wge(df_train_l$unemp) # p-value 0.28070818 <- FTR
# Therefore, we will fit the above models only instead of continuing to look for a linear signal.



# Long-term ARMA for home_price
aic5.wge(df_train_l$home_price, p = 0:5, q = 0:3)
est.hp = est.arma.wge(df_train_l$home_price, p = 1, q = 0)
preds = fore.arma.wge(df_train_l$home_price, phi = est.hp$phi, n.ahead = 60, lastn = TRUE)
ASE_ARMA_L = mean((df_test_l$home_price[1:60] - preds$f)^2)
ASE_ARMA_L # 4583718241
RMSE_ARMA_L = sqrt(mean((df_test_l$home_price - preds$f[1:60])^2))
RMSE_ARMA_L # 137303.5

# Long-term ARIMA for home_price
hp.d1 = artrans.wge(df_train_l$home_price, phi.tr = 1)
aic5.wge(hp.d1, p = 0:5, q = 0:3)
est.hp.d1 = est.arma.wge(hp.d1, p = 2, q = 3)
preds_ARIMA_L = fore.arima.wge(df_train_l$home_price, phi = est.hp.d1$phi, d = 1, n.ahead = 60, lastn = F)
ASE_ARIMA_L = mean((df_test_l$home_price[1:60] - preds_ARIMA_L$f)^2)
ASE_ARIMA_L # 62540456
RMSE_ARIMA_L = sqrt(mean((df_test_l$home_price - preds_ARIMA_L$f[1:60])^2))
RMSE_ARIMA_L # 79954.15

# Long-term ARUMA for home_price
hp.12 = artrans.wge(hp.d1, phi.tr = c(rep(0,11),1))
aic5.wge(hp.12, p = 0:5, q = 0:3)
est.hp.12 = est.arma.wge(hp.12, p = 2, q = 3)
preds = fore.aruma.wge(df_train_l$home_price, phi = est.hp.12$phi, s = 12, d = 1, n.ahead = 60, lastn = F)
ASE_ARUMA_L = mean((df_test_l$home_price[1:60] - preds$f)^2)
ASE_ARUMA_L # 278490092
RMSE_ARUMA_L = sqrt(mean((df_test_l$home_price - preds$f[1:60])^2))
RMSE_ARUMA_L # 59072.12

# Long-term Signal-Plus Noise for unemp
wbg.boot.wge(df_train_l$home_price) # p-value 0.03508772 <- Reject


# 4b. Fitting VAR model

# Short term
VARselect(df_train_s, type = "none")
var_fit_s=VAR(df_train_s,p=2,type="none")
var_fit_s
preds_var_s = predict(var_fit_s,n.ahead= 6)
ASE_VAR_S = mean((df_test_s$home_price[1:6] - preds_var_s$fcst$home_price[1:6])^2)
ASE_VAR_S

# Long term
VARselect(df_train_l, type = "both")
var_fit_l=VAR(df_train_l,p=2, lag.max = 6, season = 12)
var_fit_l
preds_var_l = predict(var_fit_l,n.ahead= 60)
ASE_VAR_L = mean((df_test_l$home_price[1:60] - preds_var_l$fcst$home_price[1:60])^2)
ASE_VAR_L

# 4c. Fitting Neural Network (mlp) model

# Short term

# Forecasting unemployment and CPI
mlp_fit_unemp_short = mlp(unemp_ts_train_s, reps = 50, comb = "median")
fore_mlp_unemp_short = forecast(mlp_fit_unemp_short, h = 6)
mlp_fit_cpi_short = mlp(cpi_ts_train_s, reps = 50, comb = "median")
fore_mlp_cpi_short = forecast(mlp_fit_cpi_short, h = 6)

# Fitting the model
mlp_fit_short = mlp(home_price_ts_train_s, xreg = data.frame(cpi = cpi_ts_train_s, unemp = unemp_ts_train_s))
df_original = data.frame(cpi = df_train_s$cpi, unemp = df_train_s$unemp)
df_fore_s = data.frame(cpi = fore_mlp_cpi_short$mean, unemp = fore_mlp_unemp_short$mean)

# Forecasting
forecast_mlp_short = forecast(mlp_fit_short, h=6, xreg = rbind(df_original, df_fore_s))
ASE_MLP_S = mean((df_test_s$home_price[1:6]-forecast_mlp_short$mean)^2)
ASE_MLP_S

# Long term

# Forecasting unemployment and CPI
mlp_fit_unemp_long = mlp(unemp_ts_train_l, reps = 50, comb = "median")
fore_mlp_unemp_long = forecast(mlp_fit_unemp_long, h = 60)
mlp_fit_cpi_long = mlp(cpi_ts_train_l, reps = 50, comb = "median")
fore_mlp_cpi_long = forecast(mlp_fit_cpi_long, h = 60)

# Fitting the model
mlp_fit_long = mlp(home_price_ts_train_l, allow.det.season = TRUE, reps = 50, comb = "median", xreg = data.frame(cpi = cpi_ts_train_l, unemp = unemp_ts_train_l))
df_original = data.frame(cpi = df_train_l$cpi, unemp = df_train_l$unemp)
df_fore_l = data.frame(cpi = fore_mlp_cpi_long$mean, unemp = fore_mlp_unemp_long$mean)

# Forecasting
forecast_mlp_long = forecast(mlp_fit_long, h=60, xreg = rbind(df_original, df_fore_l))
ASE_MLP_L = mean((df_test_l$home_price[1:60]-forecast_mlp_long$mean)^2)
ASE_MLP_L

# 4d. Fitting Ensemble model using at least two of the above.
# We are using the ARIMA and MLP models

# Short term
ensemble_s = (preds_ARIMA_S$f + forecast_mlp_short$mean)/2
ensemble_s
ASE_ENSEMBLE_S = mean((df_test_s$home_price[1:6] - ensemble_s)^2)
ASE_ENSEMBLE_S # 43293525344

# Long term
ensemble_l = (preds_ARIMA_L$f + forecast_mlp_long$mean)/2
ensemble_l
ASE_ENSEMBLE_L = mean((df_test_l$home_price[1:60] - ensemble_l)^2)
ASE_ENSEMBLE_L # 43293525344


# 5. Pick a short and long term forecast horizon based on your “problem” from part 3 above and compare all models with the ASE and the rolling window RMSE for both the short and long term forecasts 
# Short term horizon: 6 months
# Long term horizon: 5 years

# Evaluating models for short-term forecast:
RMSE_ARMA_S
# 11276.38
RMSE_ARIMA_S
# 5532.287
RMSE_ARUMA_S
# 10065.17
# ARIMA has the smallest RMSE for short-term forecast: 5532.287

ASE_ARMA_S
# 302887206
ASE_ARIMA_S
# 12498440
ASE_ARUMA_S
# 261542338
ASE_VAR_S
# 303189519
ASE_MLP_S
# 7542249
ASE_ENSEMBLE_S
# 14202982
# MLP has the smallest ASE for short-term forecast: 7542249


# Evaluating models for long-term forecast:
RMSE_ARMA_L
# 137303.5
RMSE_ARIMA_L
# 79954.15
RMSE_ARUMA_L
# 59072.12
# ARUMA has the smallest RMSE for short-term forecast: 59072.12

ASE_ARMA_L
# 18852254446
ASE_ARIMA_L
# 6392665503
ASE_ARUMA_L
# 3489515518
ASE_VAR_L
# 3380516580
ASE_MLP_L
# 3873669021
ASE_ENSEMBLE_L
# 5043349630
# VAR  has the smallest ASE for long-term forecast: 3380516580

# Plotting short-term forecast versus actual price for MLP
plot(df_test_s$home_price[1:6],type = "l")
lines(seq(1,6),forecast_mlp_short$mean, col = "blue")

# Plotting long-term forecast versus actual price for VAR
plot(df_test_l$home_price[1:60],type = "l")
lines(seq(1,60), preds_var_l$fcst$home_price[,1], col = "blue")


# 6. Provide the forecasts and prediction limits (when possible) for both the short and long term forecasts. 

# Training the model on the entire data set for short-term forecast with MLP
# Forecasting unemployment and CPI
mlp_fit_unemp_short = mlp(unemp_ts, reps = 50, comb = "median")
fore_mlp_unemp_short = forecast(mlp_fit_unemp_short, h = 6)
mlp_fit_cpi_short = mlp(cpi_ts, reps = 50, comb = "median")
fore_mlp_cpi_short = forecast(mlp_fit_cpi_short, h = 6)

# Fitting the model
mlp_fit_short = mlp(home_price_ts, xreg = data.frame(cpi = cpi_ts, unemp = unemp_ts))
df_original = data.frame(cpi = df$cpi, unemp = df$unemp)
df_fore_s = data.frame(cpi = fore_mlp_cpi_short$mean, unemp = fore_mlp_unemp_short$mean)

# Forecasting
forecast_mlp_short = forecast(mlp_fit_short, h=6, xreg = rbind(df_original, df_fore_s))
forecast_mlp_short

# Training the model on the entire data set for long-term forecast with VAR
VARselect(df, type = "both")
var_fit=VAR(df,p=2, lag.max = 6, season = 12)
preds_var = predict(var_fit,n.ahead= 60)
preds_var
```