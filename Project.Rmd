---
title: "DS 6373 Time Series Project"
author: "Alexandre Jasserme & Jae Chung"
date: "2024-04-04"
output: html_document
---

```{r setup, include=TRUE}

# Loading the libraries
library(tswge)
library(vars)
library(nnfor)
library(GGally)
library(RColorBrewer)

# TODO: ALEX
# Loading the Key Economic Indicators data (downloaded from 
# https://data.texas.gov/dataset/Key-Economic-Indicators/karz-jr5v/about_data)
kei = read.csv("Data/Key_Economic_Indicators_20240401.csv", header = TRUE)

# Checking that data was loaded correctly
head(kei)

# We are interested in the modeling the Existing Single Family Home Price TX 
# (column Q) based on the evolution of the Consumer Price Index TX (column G) 
# and Unemployment TX (column L) from January 2007 (since we have missing data 
# from previous time periods)
cpi = na.omit(kei$Consumer.Price.Index.TX)
unemp = na.omit(kei$Unemployment.TX)
home_price = na.omit(kei$Existing.Single.Family.Home.Price.TX)

# Creating the time series objects 
cpi_ts = ts(data = cpi, start = c(2007,1), frequency = 12)
unemp_ts = ts(data = unemp, start = c(2007,1), frequency = 12)
home_price_ts = ts(data = home_price, start = c(2007,1), frequency = 12)

# Plotting the data
plotts.sample.wge(cpi_ts)
plotts.sample.wge(unemp_ts)
plotts.sample.wge(home_price_ts)

# Creating a data frame:
df = data.frame(cpi, unemp, home_price)

# Looking at the data pairs
ggpairs(df)

# Training and test set for short term forecast (6 months)

# Data Frame
short_term = 6
train_index_short = nrow(df) - short_term
df_train_s = head(df, n=train_index_short)
df_test_s = tail(df, n=short_term)

# Time series
cpi_ts_train_s = ts(data = df_train_s$cpi, start = c(2007,1), frequency = 12)
unemp_ts_train_s = ts(data = df_train_s$unemp, start = c(2007,1), frequency = 12)
home_price_ts_train_s = ts(data = df_train_s$home_price, start = c(2007,1), frequency = 12)

cpi_ts_test_s = ts(data = df_test_s$cpi, start = c(2023,9), frequency = 12)
unemp_ts_test_s = ts(data = df_test_s$unemp, start = c(2023,9), frequency = 12)
home_price_ts_test_s = ts(data = df_test_s$home_price, start = c(2023,9), frequency = 12)


# Training and test set for long term forecast (5 years)

# Data Frame
long_term = 60
train_index_long = nrow(df) - long_term
df_train_l = head(df, n=train_index_long)
df_test_l = tail(df, n=long_term)

# Time series
cpi_ts_train_l = ts(data = df_train_l$cpi, start = c(2007,1), frequency = 12)
unemp_ts_train_l = ts(data = df_train_l$unemp, start = c(2007,1), frequency = 12)
home_price_ts_train_l = ts(data = df_train_l$home_price, start = c(2007,1), frequency = 12)

cpi_ts_test_l = ts(data = df_test_l$cpi, start = c(2019,3), frequency = 12)
unemp_ts_test_l = ts(data = df_test_l$unemp, start = c(2019,3), frequency = 12)
home_price_ts_test_l = ts(data = df_test_l$home_price, start = c(2019,3), frequency = 12)


# TODO: JAE
# 4a. Fitting ARMA / ARIMA / ARUMA / Signal Plus Noise (univariate analysis)

# Short-term ARMA for cpi
aic5.wge(cpi, p = 0:5, q = 0:3)
est.cpi = est.arma.wge(cpi, p = 4, q = 2)
mean(cpi)
preds = fore.arma.wge(cpi, phi = est.cpi$phi, n.ahead = 6, lastn = TRUE)
ASE = mean((cpi[(length(cpi)-6+1)] - preds$f)^2)
ASE # 3.926501

# Short-term ARIMA for cpi
cpi.d1 = artrans.wge(cpi, phi.tr = 1)
aic5.wge(cpi.d1, p = 0:5, q = 0:3)
est.cpi.d1 = est.arma.wge(cpi.d1, p = 2, q = 3)
preds = fore.arima.wge(cpi.d1, phi = est.cpi.d1$phi, d = 1, n.ahead = 6, lastn = F)
preds = fore.arima.wge(cpi, phi = est.cpi.d1$phi, d = 1, n.ahead = 6, lastn = F)
ASE = mean((cpi[(length(cpi)-6+1)] - preds$f)^2)
ASE # 7.397674

# Short-term ARUMA for cpi
cpi.12 = artrans.wge(cpi.d1, phi.tr = c(rep(0,11),1))
aic5.wge(cpi.12, p = 0:5, q = 0:3)
est.cpi12 = est.arma.wge(cpi.12, p = 2, q = 1)
preds = fore.aruma.wge(cpi.12, phi = est.cpi12$phi, s = 12, d = 1, n.ahead = 6, lastn = F)
preds = fore.aruma.wge(cpi, phi = est.cpi12$phi, s = 12, d = 1, n.ahead = 6, lastn = F)
ASE = mean((cpi[(length(cpi)-6+1)] - preds$f)^2)
ASE # 74.62757

# Short-term Signal-Plus Noise for cpi
wbg.boot.wge(cpi) # p-value 0.068 <- FTR
# Therefore, we will fit the above models only instead of continuing to look for a linear signal.
#xa = slr.wge(cpi)
#xa$res
#xa.aic = aic.burg.wge(xa$res, p = 1:5)



# Short-term ARMA for unemp
aic5.wge(unemp, p = 0:5, q = 0:3)
est.unemp = est.arma.wge(unemp, p = 1, q = 1)
mean(unemp) # (1-.913B)(X_t - 5.474) = a_t(1+.282B)
preds = fore.arma.wge(unemp, phi = est.unemp$phi, n.ahead = 6, lastn = TRUE)
ASE = mean((unemp[(length(unemp)-6+1)] - preds$f)^2)
ASE # 0.2174931

# Short-term ARIMA for unemp
unemp.d1 = artrans.wge(unemp, phi.tr = 1)
aic5.wge(unemp.d1, p = 0:5, q = 0:3)
est.unemp.d1 = est.arma.wge(unemp.d1, p = 2, q = 2) # (1-B)(1-.6192B-.2785B^2)(X_t - 5.474) = a_t(1-.4423B-.5577B^2)
preds = fore.arima.wge(unemp.d1, phi = est.unemp.d1$phi, d = 1, n.ahead = 6, lastn = F)
preds = fore.arima.wge(unemp, phi = est.unemp.d1$phi, d = 1, n.ahead = 6, lastn = F)
ASE = mean((unemp[(length(unemp)-6+1)] - preds$f)^2)
ASE # 6.968271e-30

# Short-term ARUMA for unemp
unemp.12 = artrans.wge(unemp.d1, phi.tr = c(rep(0,11),1))
aic5.wge(unemp.12, p = 0:5, q = 0:3)
est.unemp.12 = est.arma.wge(unemp.12, p = 2, q = 3) # (1-B)(1-B^12)(1+.0319B-.7455B^2)(X_t-5.474) = a_t(+.2587B-B^2-.2588B^3)
preds = fore.aruma.wge(unemp.12, phi = est.unemp.12$phi, s = 12, d = 1, n.ahead = 6, lastn = F)
preds = fore.aruma.wge(unemp, phi = est.unemp.12$phi, s = 12, d = 1, n.ahead = 6, lastn = F)
ASE = mean((unemp[(length(unemp)-6+1)] - preds$f)^2)
ASE # 0.002307583

# Short-term Signal-Plus Noise for unemp
wbg.boot.wge(unemp) # p-value 0.188 <- FTR
# Therefore, we will fit the above models only instead of continuing to look for a linear signal.




# TODO: ALEX
# 4b. Fitting VAR model
# TO DO: 
# - Basic model, need to refine it
# - Need to use prediction for home prices and inflation - use the best univariate model
# - Need to move some of the code to part 5 and 6

# Short term
VARselect(df_train_s, type = "none")
var_fit_s=VAR(df_train_s,p=2,type="none")
var_fit_s

preds_var_s = predict(var_fit_s,n.ahead= 6)

ASE_var_s = mean((df_test_s$home_price[1:6] - preds_var_s$fcst$home_price[1:6])^2)
ASE_var_s

# DISCUSS: Checking that ASE makes sense
sqrt(ASE_var_s)
preds_var_s$fcst$home_price
df_test_s$home_price

# fanchart(preds_var_s, colors = brewer.pal(n = 6, name = "Blues"))

# Long term
VARselect(df_train_l, type = "none")
var_fit_l=VAR(df_train_l,p=2,type="none")
var_fit_l


preds_var_l = predict(var_fit_l,n.ahead= 60)
ASE_var_l = mean((df_test_l$home_price[1:60] - preds_var_l$fcst$home_price[1:60])^2)
ASE_var_l

# fanchart(preds_var_l, colors = brewer.pal(n = 6, name = "Blues"))






# TODO: ALEX
# 4c. Fitting Neural Network (mlp) model
# TO DO: very basic model, need to refine it
mlp_fit_short = mlp(home_price_ts_train_s, xreg = data.frame(cpi_ts_train_s, unemp_ts_train_s))
mlp_fit_short

mlp_fit_long = mlp(home_price_ts_train_l, xreg = data.frame(cpi_ts_train_l, unemp_ts_train_l))
mlp_fit_long

# TODO: JAE
# 4d. Fitting Ensemble model using at least two of the above. 


# Waiting until we have fleshed out the models
# 5. Pick a short and long term forecast horizon based on your “problem” from part 3 above and compare all models with the ASE and the rolling window RMSE for both the short and long term forecasts 
# Short term: 6 months
# Long term: 5 years




# Waiting until we have fleshed out the models
# 6. Provide the forecasts and prediction limits (when possible) for both the short and long term forecasts. 
# Waiting until we have fleshed out the models
```